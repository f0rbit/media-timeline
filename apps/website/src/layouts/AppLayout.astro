---
import ProfileSelector from "../components/solid/ProfileSelector.tsx";
import { fetchAuthStatusServer, fetchProfilesServer } from "../utils/api";
import Layout from "./Layout.astro";

interface Props {
	title?: string;
	description?: string;
	ogImage?: string;
	noindex?: boolean;
}

const { title = "Media Timeline", description, ogImage, noindex } = Astro.props;

const pages = [
	{ name: "dashboard", href: "/dashboard" },
	{ name: "timeline", href: "/timeline" },
	{ name: "connections", href: "/connections" },
];

const currentPath = Astro.url.pathname;
const active = pages.find(p => currentPath.startsWith(p.href))?.name ?? "";

const profileSlug = Astro.url.searchParams.get("profile");

// Fetch auth status and profiles using SSR with cookie forwarding
const authStatus = await fetchAuthStatusServer(Astro.request);
const initialProfiles = await fetchProfilesServer(Astro.request);
const isAuthenticated = import.meta.env.DEV || authStatus.authenticated;

const buildUrl = (path: string) => {
	if (!profileSlug) return path;
	return `${path}?profile=${encodeURIComponent(profileSlug)}`;
};
---

<Layout title={title} description={description} ogImage={ogImage} noindex={noindex}>
  <body>
    <div id="container">
      <header>
        <div class="header-left">
          <a href={buildUrl("/dashboard")}><h5>media timeline</h5></a>
          <div class="profile-selector-wrapper">
            <ProfileSelector 
              client:load
              currentSlug={profileSlug}
              initialProfiles={initialProfiles}
              isAuthenticated={isAuthenticated}
            />
          </div>
        </div>
        <nav>
          {pages.map(p => (
            <a href={buildUrl(p.href)} class={active === p.name ? "active" : ""}>
              {p.name}
            </a>
          ))}
        </nav>
      </header>
      <main class="flex-col">
        <slot />
      </main>
    </div>
    <footer>
      <p class="description">media.devpad.tools</p>
    </footer>
  </body>
</Layout>

<style>
  main {
    margin-top: 24px;
  }
  
  .header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  /* Reserve space for profile selector to prevent layout shift */
  .profile-selector-wrapper {
    min-width: 100px;
    min-height: 32px;
    display: flex;
    align-items: center;
  }
</style>
