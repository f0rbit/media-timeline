---
import "../utils/error-logger";
import ProfileSelector from "../components/solid/ProfileSelector.tsx";
import { getSSRAuth } from "../utils/ssr-auth";
import Layout from "./Layout.astro";

interface Props {
	title?: string;
	description?: string;
	ogImage?: string;
	noindex?: boolean;
}

const { title = "Media Timeline", description, ogImage, noindex } = Astro.props;

const pages = [
	{ name: "dashboard", href: "/dashboard" },
	{ name: "timeline", href: "/timeline" },
	{ name: "connections", href: "/connections" },
];

const currentPath = Astro.url.pathname;
const active = pages.find(p => currentPath.startsWith(p.href))?.name ?? "";

const profileSlug = Astro.url.searchParams.get("profile");

const buildUrl = (path: string) => {
	if (!profileSlug) return path;
	return `${path}?profile=${encodeURIComponent(profileSlug)}`;
};

// Fetch auth status and profiles using direct database access
let isAuthenticated = false;
let initialProfiles: { id: string; slug: string; name: string; description: string | null; created_at: string }[] = [];

// @ts-expect-error - Astro.locals.runtime is provided by Cloudflare adapter
const runtime = Astro.locals.runtime;

if (runtime?.env?.DB) {
	try {
		const authResult = await getSSRAuth(Astro.request, runtime);
		isAuthenticated = authResult.authenticated;
		initialProfiles = authResult.profiles;
	} catch {
		// Auth failed, will show login button
	}
}
---

<Layout title={title} description={description} ogImage={ogImage} noindex={noindex}>
  <body>
    <div id="container">
      <header>
        <div class="header-left">
          <a href={buildUrl("/dashboard")}><h5>media timeline</h5></a>
          <div class="profile-selector-wrapper">
            <ProfileSelector 
              client:load
              currentSlug={profileSlug}
              initialProfiles={initialProfiles}
              isAuthenticated={isAuthenticated}
            />
          </div>
        </div>
        <nav>
          {pages.map(p => (
            <a href={buildUrl(p.href)} class={active === p.name ? "active" : ""}>
              {p.name}
            </a>
          ))}
        </nav>
      </header>
      <main class="flex-col">
        <slot />
      </main>
    </div>
    <footer>
      <p class="description">media.devpad.tools</p>
    </footer>
  </body>
</Layout>

<style>
  main {
    margin-top: 24px;
  }
  
  .header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  /* Reserve space for profile selector to prevent layout shift */
  .profile-selector-wrapper {
    min-width: 100px;
    min-height: 32px;
    display: flex;
    align-items: center;
  }
</style>
